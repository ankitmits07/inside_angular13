<div class="container mt-4">
  <!-- Toggle Button -->
  <div class="d-flex justify-content-end mb-3">
    <button class="btn btn-secondary" (click)="toggleView()">
      {{ showUserTable ? 'Show Registration Form' : 'View All Users' }}
    </button>
  </div>

  <!-- Registration Form -->
  <div *ngIf="!showUserTable" class="bg-light py-5">
    <div class="card shadow p-4 mx-auto" style="max-width: 900px; border-radius: 1rem;">
      <h3 class="text-center fw-bold mb-4" style="color: #343a40;">User Registration</h3>

      <form [formGroup]="userForm" (ngSubmit)="onSubmit()" enctype="multipart/form-data" novalidate>
        <div class="row g-3">

          <!-- Name -->
          <div class="col-md-6">
            <label class="form-label">Name</label>
            <input type="text" formControlName="name" class="form-control"
                   [class.is-invalid]="getBackendError('name')">
            <div class="invalid-feedback" *ngIf="getBackendError('name')">{{ getBackendError('name') }}</div>
          </div>

          <!-- Email -->
          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="email" formControlName="email" class="form-control"
                   [class.is-invalid]="getBackendError('email')">
            <div class="invalid-feedback" *ngIf="getBackendError('email')">{{ getBackendError('email') }}</div>
          </div>

          <!-- Password -->
          <div class="col-md-6">
            <label class="form-label">Password</label>
            <input type="password" formControlName="password" class="form-control"
                   [class.is-invalid]="getBackendError('password')">
            <div class="invalid-feedback" *ngIf="getBackendError('password')">{{ getBackendError('password') }}</div>
          </div>

          <!-- Phone -->
          <div class="col-md-6">
            <label class="form-label">Phone</label>
            <input type="text" formControlName="phone" class="form-control"
                   [class.is-invalid]="getBackendError('phone')">
            <div class="invalid-feedback" *ngIf="getBackendError('phone')">{{ getBackendError('phone') }}</div>
          </div>

          <!-- Country -->
          <div class="col-md-4">
            <label class="form-label">Country</label>
            <select formControlName="country" class="form-control"
                    [class.is-invalid]="getBackendError('country')">
              <option value="">Select Country</option>
              <option *ngFor="let c of countries" [ngValue]="c">{{ c.country_name }}</option>
            </select>
            <div class="invalid-feedback" *ngIf="getBackendError('country')">{{ getBackendError('country') }}</div>
          </div>

          <!-- State -->
          <div class="col-md-4">
            <label class="form-label">State</label>
            <select formControlName="state" class="form-control"
                    [class.is-invalid]="getBackendError('state')">
              <option value="">Select State</option>
              <option *ngFor="let s of states" [ngValue]="s">{{ s.state_name }}</option>
            </select>
            <div class="invalid-feedback" *ngIf="getBackendError('state')">{{ getBackendError('state') }}</div>
          </div>

          <!-- City -->
          <div class="col-md-4">
            <label class="form-label">City</label>
            <select *ngIf="cities.length" formControlName="city" class="form-control"
                    [class.is-invalid]="getBackendError('city')">
              <option value="">Select City</option>
              <option *ngFor="let city of cities" [ngValue]="city">{{ city.city_name }}</option>
            </select>
            <input *ngIf="!cities.length" type="text" formControlName="city" class="form-control" placeholder="Enter city"
                   [class.is-invalid]="getBackendError('city')">
            <div class="invalid-feedback" *ngIf="getBackendError('city')">{{ getBackendError('city') }}</div>
          </div>

          <!-- Pincode -->
          <div class="col-md-6">
            <label class="form-label">Pincode</label>
            <input type="text" formControlName="pincode" class="form-control"
                   [class.is-invalid]="getBackendError('pincode')">
            <div class="invalid-feedback" *ngIf="getBackendError('pincode')">{{ getBackendError('pincode') }}</div>
          </div>

          <!-- Image Upload -->
          <div class="col-md-6">
            <label class="form-label">Profile Image (JPG, max 75KB)</label>
            <input type="file" (change)="onFileSelected($event)" class="form-control" accept=".jpg,.jpeg,.png"
                   [class.is-invalid]="getBackendError('image')">
            <div *ngIf="previewUrl" class="mt-2">
              <img [src]="previewUrl" class="img-thumbnail" style="max-height:150px;">
            </div>
            <div class="invalid-feedback" *ngIf="getBackendError('image')">{{ getBackendError('image') }}</div>
          </div>

        </div>

        <!-- Submit -->
        <div class="mt-4">
          <button class="btn btn-primary w-100 fw-semibold"
                  [disabled]="isLoading"
                  style="border-radius:0.5rem; font-size:1rem;">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
            {{ isLoading ? 'Submitting...' : 'Register' }}
          </button>
        </div>
      </form>

      <!-- General backend error -->
      <div class="text-danger mt-3 text-center fw-semibold" *ngIf="backendErrors.general">
        {{ backendErrors.general }}
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div *ngIf="showUserTable" class="card shadow mt-4">
    <div class="card-header bg-primary text-white">
      <h3 class="text-center">Registered Users</h3>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>Name</th><th>Email</th><th>Phone</th>
              <th>Country</th><th>State</th><th>City</th>
              <th>Pincode</th><th>Profile Image</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of users">
              <td>{{ user.name }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.phone }}</td>
              <td>{{ user.country }}</td>
              <td>{{ user.state || 'N/A' }}</td>
              <td>{{ user.city }}</td>
              <td>{{ user.pincode }}</td>
              <td>
                <img *ngIf="user.image" [src]="apiUrl + '/uploads/' + user.image"
                     class="img-thumbnail" style="max-height:80px;">
                <span *ngIf="!user.image">No image</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
